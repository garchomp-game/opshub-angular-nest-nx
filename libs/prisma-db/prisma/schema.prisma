generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ───

enum Role {
  member
  approver
  pm
  accounting
  it_admin
  tenant_admin
}

enum ProjectStatus {
  planning
  active
  completed
  cancelled
}

enum TaskStatus {
  todo
  in_progress
  done
}

enum WorkflowType {
  expense
  leave
  purchase
  other
}

enum WorkflowStatus {
  draft
  submitted
  approved
  rejected
  withdrawn
}

enum InvoiceStatus {
  draft
  sent
  paid
  cancelled
}

// ─── Models ───

/// カスタムの User モデル（Supabase の auth.users に相当）
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  // Relations
  profile             Profile?
  roles               UserRole[]           @relation("UserRoles")
  managedProjects     Project[]            @relation("ProjectManager")
  createdProjects     Project[]            @relation("ProjectCreator")
  updatedProjects     Project[]            @relation("ProjectUpdater")
  projectMembers      ProjectMember[]
  assignedTasks       Task[]               @relation("TaskAssignee")
  createdTasks        Task[]               @relation("TaskCreator")
  createdWorkflows    Workflow[]           @relation("WorkflowCreator")
  approvedWorkflows   Workflow[]           @relation("WorkflowApprover")
  timesheets          Timesheet[]
  createdExpenses     Expense[]            @relation("ExpenseCreator")
  auditLogs           AuditLog[]
  notifications       Notification[]
  workflowAttachments WorkflowAttachment[] @relation("AttachmentUploader")
  createdInvoices     Invoice[]            @relation("InvoiceCreator")
  uploadedDocuments   Document[]           @relation("DocumentUploader")

  @@map("users")
}

/// テナント
model Tenant {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  settings    Json?     @default("{}")
  workflowSeq Int       @default(0) @map("workflow_seq")
  invoiceSeq  Int       @default(0) @map("invoice_seq")
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at")

  // Relations
  userRoles           UserRole[]
  projects            Project[]
  projectMembers      ProjectMember[]
  tasks               Task[]
  workflows           Workflow[]
  timesheets          Timesheet[]
  expenses            Expense[]
  auditLogs           AuditLog[]
  notifications       Notification[]
  workflowAttachments WorkflowAttachment[]
  invoices            Invoice[]
  invoiceItems        InvoiceItem[]
  documents           Document[]

  @@map("tenants")
}

/// ユーザーロール
model UserRole {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  tenantId  String   @map("tenant_id")
  role      Role
  createdAt DateTime @default(now()) @map("created_at")

  user   User   @relation("UserRoles", fields: [userId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([userId, tenantId, role])
  @@index([tenantId, userId])
  @@index([userId])
  @@map("user_roles")
}

/// ユーザープロファイル
model Profile {
  id          String   @id
  displayName String   @map("display_name")
  avatarUrl   String?  @map("avatar_url")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  user User @relation(fields: [id], references: [id], onDelete: Cascade)

  @@map("profiles")
}

/// プロジェクト
model Project {
  id          String        @id @default(uuid())
  tenantId    String        @map("tenant_id")
  name        String
  description String?
  status      ProjectStatus
  startDate   DateTime?     @db.Date @map("start_date")
  endDate     DateTime?     @db.Date @map("end_date")
  pmId        String        @map("pm_id")
  createdBy   String        @map("created_by")
  updatedBy   String?       @map("updated_by")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @default(now()) @updatedAt @map("updated_at")

  tenant  Tenant @relation(fields: [tenantId], references: [id])
  pm      User   @relation("ProjectManager", fields: [pmId], references: [id])
  creator User   @relation("ProjectCreator", fields: [createdBy], references: [id])
  updater User?  @relation("ProjectUpdater", fields: [updatedBy], references: [id])

  members    ProjectMember[]
  tasks      Task[]
  timesheets Timesheet[]
  expenses   Expense[]
  invoices   Invoice[]
  documents  Document[]

  @@index([tenantId, status])
  @@index([tenantId, pmId])
  @@map("projects")
}

/// プロジェクトメンバー
model ProjectMember {
  id        String   @id @default(uuid())
  projectId String   @map("project_id")
  userId    String   @map("user_id")
  tenantId  String   @map("tenant_id")
  createdAt DateTime @default(now()) @map("created_at")

  project Project @relation(fields: [projectId], references: [id])
  user    User    @relation(fields: [userId], references: [id])
  tenant  Tenant  @relation(fields: [tenantId], references: [id])

  @@unique([projectId, userId])
  @@index([tenantId, userId])
  @@map("project_members")
}

/// タスク
model Task {
  id          String     @id @default(uuid())
  tenantId    String     @map("tenant_id")
  projectId   String     @map("project_id")
  title       String
  description String?
  status      TaskStatus @default(todo)
  assigneeId  String?    @map("assignee_id")
  dueDate     DateTime?  @db.Date @map("due_date")
  createdBy   String     @map("created_by")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @default(now()) @updatedAt @map("updated_at")

  tenant   Tenant  @relation(fields: [tenantId], references: [id])
  project  Project @relation(fields: [projectId], references: [id])
  assignee User?   @relation("TaskAssignee", fields: [assigneeId], references: [id])
  creator  User    @relation("TaskCreator", fields: [createdBy], references: [id])

  timesheets Timesheet[]

  @@index([tenantId, projectId])
  @@index([tenantId, assigneeId])
  @@map("tasks")
}

/// ワークフロー（申請）
model Workflow {
  id              String         @id @default(uuid())
  tenantId        String         @map("tenant_id")
  workflowNumber  String         @map("workflow_number")
  type            WorkflowType
  title           String
  description     String?
  status          WorkflowStatus @default(draft)
  amount          Decimal?       @db.Decimal(12, 2)
  dateFrom        DateTime?      @db.Date @map("date_from")
  dateTo          DateTime?      @db.Date @map("date_to")
  approverId      String?        @map("approver_id")
  rejectionReason String?        @map("rejection_reason")
  createdBy       String         @map("created_by")
  approvedAt      DateTime?      @map("approved_at")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @default(now()) @updatedAt @map("updated_at")

  tenant   Tenant @relation(fields: [tenantId], references: [id])
  approver User?  @relation("WorkflowApprover", fields: [approverId], references: [id])
  creator  User   @relation("WorkflowCreator", fields: [createdBy], references: [id])

  expenses    Expense[]
  attachments WorkflowAttachment[]

  @@unique([tenantId, workflowNumber])
  @@index([tenantId, status])
  @@index([tenantId, createdBy])
  @@index([tenantId, approverId, status])
  @@map("workflows")
}

/// 工数（タイムシート）
model Timesheet {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  userId    String   @map("user_id")
  projectId String   @map("project_id")
  taskId    String?  @map("task_id")
  workDate  DateTime @db.Date @map("work_date")
  hours     Decimal  @db.Decimal(4, 2)
  note      String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  tenant  Tenant  @relation(fields: [tenantId], references: [id])
  user    User    @relation(fields: [userId], references: [id])
  project Project @relation(fields: [projectId], references: [id])
  task    Task?   @relation(fields: [taskId], references: [id])

  @@unique([userId, projectId, taskId, workDate])
  @@index([tenantId, userId, workDate])
  @@index([tenantId, projectId, workDate])
  @@map("timesheets")
}

/// 経費
model Expense {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  workflowId  String?  @map("workflow_id")
  projectId   String?  @map("project_id")
  category    String
  amount      Decimal  @db.Decimal(12, 2)
  expenseDate DateTime @db.Date @map("expense_date")
  description String?
  receiptUrl  String?  @map("receipt_url")
  createdBy   String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  tenant   Tenant    @relation(fields: [tenantId], references: [id])
  workflow Workflow? @relation(fields: [workflowId], references: [id])
  project  Project?  @relation(fields: [projectId], references: [id])
  creator  User      @relation("ExpenseCreator", fields: [createdBy], references: [id])

  @@index([tenantId, createdBy])
  @@index([tenantId, projectId])
  @@map("expenses")
}

/// 監査ログ
model AuditLog {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  userId       String   @map("user_id")
  action       String
  resourceType String   @map("resource_type")
  resourceId   String?  @map("resource_id")
  beforeData   Json?    @map("before_data")
  afterData    Json?    @map("after_data")
  metadata     Json?    @default("{}")
  createdAt    DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@index([tenantId, createdAt(sort: Desc)])
  @@index([tenantId, resourceType, resourceId])
  @@index([tenantId, userId])
  @@map("audit_logs")
}

/// 通知
model Notification {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  userId       String   @map("user_id")
  type         String
  title        String
  body         String?
  resourceType String?  @map("resource_type")
  resourceId   String?  @map("resource_id")
  isRead       Boolean  @default(false) @map("is_read")
  createdAt    DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@index([tenantId, userId, isRead, createdAt(sort: Desc)])
  @@map("notifications")
}

/// 申請添付ファイル
model WorkflowAttachment {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  workflowId  String   @map("workflow_id")
  fileName    String   @map("file_name")
  fileSize    Int      @map("file_size")
  contentType String   @map("content_type")
  storagePath String   @map("storage_path")
  uploadedBy  String   @map("uploaded_by")
  createdAt   DateTime @default(now()) @map("created_at")

  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  uploader User     @relation("AttachmentUploader", fields: [uploadedBy], references: [id])

  @@index([tenantId, workflowId])
  @@map("workflow_attachments")
}

/// 請求書
model Invoice {
  id            String        @id @default(uuid())
  tenantId      String        @map("tenant_id")
  invoiceNumber String        @map("invoice_number")
  projectId     String?       @map("project_id")
  clientName    String        @map("client_name")
  issuedDate    DateTime      @db.Date @map("issued_date")
  dueDate       DateTime      @db.Date @map("due_date")
  subtotal      Decimal       @default(0) @db.Decimal(12, 0)
  taxRate       Decimal       @default(10.00) @db.Decimal(5, 2)
  taxAmount     Decimal       @default(0) @db.Decimal(12, 0)
  totalAmount   Decimal       @default(0) @db.Decimal(12, 0)
  status        InvoiceStatus @default(draft)
  notes         String?
  createdBy     String        @map("created_by")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @default(now()) @updatedAt @map("updated_at")

  tenant  Tenant   @relation(fields: [tenantId], references: [id])
  project Project? @relation(fields: [projectId], references: [id])
  creator User     @relation("InvoiceCreator", fields: [createdBy], references: [id])

  items InvoiceItem[]

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId, status])
  @@index([tenantId, projectId])
  @@index([tenantId, createdAt(sort: Desc)])
  @@map("invoices")
}

/// 請求明細
model InvoiceItem {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  invoiceId   String   @map("invoice_id")
  description String
  quantity    Decimal  @default(1) @db.Decimal(10, 2)
  unitPrice   Decimal  @db.Decimal(12, 0)
  amount      Decimal  @db.Decimal(12, 0)
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")

  tenant  Tenant  @relation(fields: [tenantId], references: [id])
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([tenantId, invoiceId])
  @@map("invoice_items")
}

/// ドキュメント
model Document {
  id         String   @id @default(uuid())
  tenantId   String   @map("tenant_id")
  projectId  String?  @map("project_id")
  name       String
  filePath   String   @map("file_path")
  fileSize   BigInt   @default(0) @map("file_size")
  mimeType   String   @map("mime_type")
  uploadedBy String   @map("uploaded_by")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at")

  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  project  Project? @relation(fields: [projectId], references: [id])
  uploader User     @relation("DocumentUploader", fields: [uploadedBy], references: [id])

  @@index([tenantId, projectId])
  @@map("documents")
}
